@page "/masters/temployee/edit/{Id:int}"
@rendermode InteractiveServer
@using ConferenceHallManagement.Web.ViewModels
@using ConferenceHallManagement.web.Services
@using Models_ConferenceHallManagement.AppDbModels
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization

@inject ITempEmployeeRoleBlazorService Service
@inject IMasterDataService MasterService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-4">
    @if (isLoading)
    {
        <div class="text-center pt-5"><div class="spinner-border text-primary"></div></div>
    }
    else if (model == null)
    {
        <div class="alert alert-danger text-center shadow-sm" style="max-width: 500px; margin: auto;">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> Role Not Found!
            <br />
            <a href="/masters/temployee" class="btn btn-sm btn-outline-danger mt-2">Back to List</a>
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0" style="max-width: 600px; margin: auto;">
            <div class="card-header bg-warning bg-opacity-10 border-bottom py-3">
                <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-pencil-square me-2"></i>Edit Employee Role</h5>
            </div>
            <div class="card-body p-4">
                <EditForm Model="model" OnValidSubmit="Update">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">EMPLOYEE NUMBER</label>
                        <InputText @bind-Value="model.EmployeeNo" class="form-control" />
                        <ValidationMessage For="@(() => model.EmployeeNo)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">REGION</label>
                        <select class="form-select" value="@model.RegionId" @onchange="OnRegionChange">
                            <option value="0">-- Select Region --</option>
                            @foreach (var r in Regions)
                            {
                                <option value="@r.Id">@r.RegionName</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">LOCATION</label>
                        <InputSelect @bind-Value="model.LocationId" class="form-select" disabled="@(!Locations.Any())">
                            <option value="0">-- Select Location --</option>
                            @foreach (var l in Locations)
                            {
                                <option value="@l.Id">@l.LocationName</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">ROLE</label>
                        <InputSelect @bind-Value="model.RoleId" class="form-select">
                            @foreach (var role in AllowedRoles)
                            {
                                <option value="@role.GetType().GetProperty("Id").GetValue(role, null)">
                                    @role.GetType().GetProperty("RoleName").GetValue(role, null)
                                </option>
                            }
                        </InputSelect>
                    </div>

                    <div class="form-check form-switch mb-4">
                        <InputCheckbox @bind-Value="model.IsActive" class="form-check-input" />
                        <label class="form-check-label fw-bold small">Active Status</label>
                    </div>

                    <div class="d-flex justify-content-between pt-2 border-top">
                        <button type="button" class="btn btn-light text-muted" @onclick='() => Navigation.NavigateTo("/masters/temployee")'>Cancel</button>
                        <button type="submit" class="btn btn-primary px-4" disabled="@isSaving">Update Changes</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }
    private TempEmployeeRoleVM? model;
    private bool isLoading = true;
    private bool isSaving = false;

    private List<MasterRegion> Regions = new();
    private List<MasterLocation> Locations = new();
    private List<dynamic> AllowedRoles = new();
    private int CurrentUserRoleId = 1;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var roleName = authState.User.FindFirst(ClaimTypes.Role)?.Value;

        if (roleName == "Super Admin") CurrentUserRoleId = 1;
        else if (roleName == "Central Admin") CurrentUserRoleId = 2;
        else if (roleName == "Regional Admin") CurrentUserRoleId = 3;
        else if (roleName == "Station Admin") CurrentUserRoleId = 4;

        Regions = await MasterService.GetAllRegionsAsync();
        var allRoles = await MasterService.GetAllRolesAsync();

        // Filter logic same as Create
        AllowedRoles = allRoles.Where(r => (int)r.GetType().GetProperty("Id").GetValue(r, null) >= CurrentUserRoleId).ToList();

        model = await Service.GetByIdAsync(Id);

        if (model != null && model.RegionId > 0)
        {
            Locations = await MasterService.GetLocationsByRegionAsync(model.RegionId);
        }

        isLoading = false;
    }

    private async Task OnRegionChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id) && id > 0)
        {
            model!.RegionId = id;
            Locations = await MasterService.GetLocationsByRegionAsync(id);
            model.LocationId = 0;
        }
        else
        {
            model!.RegionId = 0;
            Locations = new();
        }
    }

    private async Task Update()
    {
        isSaving = true;
        var result = await Service.UpdateAsync(model!);
        if (result > 0)
        {
            await JS.InvokeVoidAsync("alert", "Updated Successfully!");
            Navigation.NavigateTo("/masters/temployee");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Update failed.");
        }
        isSaving = false;
    }
}