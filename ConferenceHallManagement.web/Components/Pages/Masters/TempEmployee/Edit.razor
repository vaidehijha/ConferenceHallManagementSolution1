@page "/masters/temployee/edit/{Id:int}"
@rendermode InteractiveServer
@using ConferenceHallManagement.Web.ViewModels
@using ConferenceHallManagement.web.Services
@using ConferenceHallManagement.Web.Services
@using Models_ConferenceHallManagement.AppDbModels
@using Models_ConferenceHallManagement.DTOs
@using Models_ConferenceHallManagement.Extensions
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using UoW_ConferenceHallManagement

@inject ITempEmployeeRoleBlazorService Service
@inject IMasterDataService MasterService
@inject UserSessionService SessionService
@inject IUnitOfWork _uow
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-4">
    @if (isLoading)
    {
        <div class="text-center pt-5"><div class="spinner-border text-primary"></div></div>
    }
    else if (model == null)
    {
        <div class="alert alert-danger text-center shadow-sm" style="max-width: 500px; margin: auto;">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> Role Not Found!
            <br />
            <a href="/masters/temployee" class="btn btn-sm btn-outline-danger mt-2">Back to List</a>
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0" style="max-width: 600px; margin: auto;">
            <div class="card-header bg-warning bg-opacity-10 border-bottom py-3">
                <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-pencil-square me-2"></i>Edit Employee Role</h5>
            </div>
            <div class="card-body p-4">
                <EditForm Model="model" OnValidSubmit="Update">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">EMPLOYEE NUMBER</label>
                        <InputText @bind-Value="model.EmployeeNo" class="form-control" />
                        <ValidationMessage For="@(() => model.EmployeeNo)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">REGION</label>
                        <select class="form-select" value="@model.RegionId" @onchange="OnRegionChange" disabled="@(isRegionalAdmin || isStationAdmin)">
                            <option value="0">-- Select Region --</option>
                            @foreach (var r in Regions)
                            {
                                <option value="@r.Id">@r.RegionName</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">LOCATION</label>
                        <InputSelect @bind-Value="model.LocationId" class="form-select" disabled="@(isStationAdmin || !Locations.Any())">
                            <option value="0">-- Select Location --</option>
                            @foreach (var l in Locations)
                            {
                                <option value="@l.Id">@l.LocationName</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">ROLE</label>
                        <InputSelect @bind-Value="model.RoleId" class="form-select">
                            @foreach (var role in AllowedRoles)
                            {
                                <option value="@role.Id">@role.RoleName</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="form-check form-switch mb-4">
                        <InputCheckbox @bind-Value="model.IsActive" class="form-check-input" />
                        <label class="form-check-label fw-bold small">Active Status</label>
                    </div>

                    <div class="d-flex justify-content-between pt-2 border-top">
                        <button type="button" class="btn btn-light text-muted" @onclick='() => Navigation.NavigateTo("/masters/temployee")'>Cancel</button>
                        <button type="submit" class="btn btn-primary px-4" disabled="@isSaving">Update Changes</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }
    private TempEmployeeRoleVM? model;
    private bool isLoading = true;
    private bool isSaving = false;

    private List<MasterRegion> Regions = new();
    private List<MasterLocation> Locations = new();
    private List<MasterRole> AllowedRoles = new();
    private int CurrentUserRoleId = 0;
    private int? CurrentUserRegionId = null;
    private int? CurrentUserLocationId = null;
    private bool isRegionalAdmin = false;
    private bool isStationAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        // Get current user session
        var userSession = await SessionService.GetUserSessionAsync();
        if (userSession != null)
        {
            var primaryRole = userSession.GetPrimaryRole();
            if (primaryRole != null)
            {
                CurrentUserRoleId = primaryRole.RoleId;
                CurrentUserRegionId = primaryRole.RegionId;
                CurrentUserLocationId = primaryRole.LocationId;
                
                // Check role type
                if (CurrentUserRoleId == 3)
                {
                    isRegionalAdmin = true;
                }
                else if (CurrentUserRoleId == 4)
                {
                    isStationAdmin = true;
                }
            }
        }

        // Load Regions
        var allRegions = await MasterService.GetAllRegionsAsync();
        
        // Filter regions based on role
        if (isRegionalAdmin && CurrentUserRegionId.HasValue)
        {
            Regions = allRegions.Where(r => r.Id == CurrentUserRegionId.Value).ToList();
        }
        else if (isStationAdmin && CurrentUserRegionId.HasValue)
        {
            Regions = allRegions.Where(r => r.Id == CurrentUserRegionId.Value).ToList();
        }
        else
        {
            Regions = allRegions;
        }
        
        // Load and filter Roles from Database
        var allDbRoles = await _uow.MasterRoleDataRepository.GetAllAsync();

        // Filtering logic:
        if (CurrentUserRoleId == 1)
        {
            // Super Admin sees all roles
            AllowedRoles = allDbRoles.OrderBy(r => r.Id).ToList();
        }
        else if (CurrentUserRoleId == 2)
        {
            // Central Admin cannot see Super Admin (RoleId = 1)
            AllowedRoles = allDbRoles
                .Where(r => r.Id >= 2)
                .OrderBy(r => r.Id)
                .ToList();
        }
        else if (CurrentUserRoleId == 3)
        {
            // Regional Admin can only edit Regional Admin (3) and Station Admin (4)
            AllowedRoles = allDbRoles
                .Where(r => r.Id == 3 || r.Id == 4)
                .OrderBy(r => r.Id)
                .ToList();
        }
        else if (CurrentUserRoleId == 4)
        {
            // Station Admin can only edit Station Admin (4)
            AllowedRoles = allDbRoles
                .Where(r => r.Id == 4)
                .OrderBy(r => r.Id)
                .ToList();
        }
        else
        {
            // Others see their level or below
            AllowedRoles = allDbRoles
                .Where(r => r.Id >= CurrentUserRoleId)
                .OrderBy(r => r.Id)
                .ToList();
        }

        model = await Service.GetByIdAsync(Id);

        if (model != null)
        {
            // If Central Admin tries to edit a Super Admin role, redirect them back
            if (CurrentUserRoleId == 2 && model.RoleId == 1)
            {
                await JS.InvokeVoidAsync("alert", "You do not have permission to edit Super Admin roles.");
                Navigation.NavigateTo("/masters/temployee");
                return;
            }

            // If Regional Admin tries to edit a role outside their region, redirect them back
            if (isRegionalAdmin && CurrentUserRegionId.HasValue && model.RegionId != CurrentUserRegionId.Value)
            {
                await JS.InvokeVoidAsync("alert", "You can only edit roles in your region.");
                Navigation.NavigateTo("/masters/temployee");
                return;
            }

            // If Regional Admin tries to edit Super Admin or Central Admin, redirect them back
            if (CurrentUserRoleId == 3 && (model.RoleId == 1 || model.RoleId == 2))
            {
                await JS.InvokeVoidAsync("alert", "You do not have permission to edit this role.");
                Navigation.NavigateTo("/masters/temployee");
                return;
            }

            // If Station Admin tries to edit a role outside their location, redirect them back
            if (isStationAdmin && CurrentUserLocationId.HasValue && model.LocationId != CurrentUserLocationId.Value)
            {
                await JS.InvokeVoidAsync("alert", "You can only edit roles in your location.");
                Navigation.NavigateTo("/masters/temployee");
                return;
            }

            // If Station Admin tries to edit non-Station Admin roles, redirect them back
            if (CurrentUserRoleId == 4 && model.RoleId != 4)
            {
                await JS.InvokeVoidAsync("alert", "You can only edit Station Admin roles.");
                Navigation.NavigateTo("/masters/temployee");
                return;
            }

            if (model.RegionId > 0)
            {
                Locations = await MasterService.GetLocationsByRegionAsync(model.RegionId);
            }
        }

        isLoading = false;
    }

    private async Task OnRegionChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id) && id > 0)
        {
            model!.RegionId = id;
            Locations = await MasterService.GetLocationsByRegionAsync(id);
            model.LocationId = 0;
        }
        else
        {
            model!.RegionId = 0;
            Locations = new();
        }
    }

    private async Task Update()
    {
        isSaving = true;
        var result = await Service.UpdateAsync(model!);
        if (result > 0)
        {
            await JS.InvokeVoidAsync("alert", "Updated Successfully!");
            Navigation.NavigateTo("/masters/temployee");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Update failed.");
        }
        isSaving = false;
    }
}