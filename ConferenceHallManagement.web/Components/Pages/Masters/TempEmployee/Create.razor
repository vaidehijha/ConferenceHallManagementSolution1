@page "/masters/temployee/create"
@rendermode InteractiveServer
@using ConferenceHallManagement.Web.ViewModels
@using ConferenceHallManagement.web.Services
@using ConferenceHallManagement.Web.Services
@using Models_ConferenceHallManagement.AppDbModels
@using Models_ConferenceHallManagement.DTOs
@using Models_ConferenceHallManagement.Extensions
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using UoW_ConferenceHallManagement

@inject ITempEmployeeRoleBlazorService Service
@inject IMasterDataService MasterService
@inject UserSessionService SessionService
@inject IUnitOfWork _uow
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-4">
    <div class="card shadow-sm border-0" style="max-width: 600px; margin: auto;">
        <div class="card-header bg-white border-bottom py-3">
            <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-person-plus me-2"></i>Add Employee Role</h5>
        </div>
        <div class="card-body p-4">
            <EditForm Model="model" OnValidSubmit="Save">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">EMPLOYEE NUMBER <span class="text-danger">*</span></label>
                    <InputText @bind-Value="model.EmployeeNo" class="form-control" placeholder="e.g. 60020656" />
                    <ValidationMessage For="@(() => model.EmployeeNo)" />
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">REGION <span class="text-danger">*</span></label>
                    <select class="form-select" value="@model.RegionId" @onchange="OnRegionChange" disabled="@(isRegionalAdmin || isStationAdmin)">
                        <option value="0">-- Select Region --</option>
                        @foreach (var r in Regions)
                        {
                            <option value="@r.Id">@r.RegionName</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">LOCATION <span class="text-danger">*</span></label>
                    <InputSelect @bind-Value="model.LocationId" class="form-select" disabled="@(isStationAdmin || !Locations.Any())">
                        <option value="0">-- Select Location --</option>
                        @foreach (var l in Locations)
                        {
                            <option value="@l.Id">@l.LocationName</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">ASSIGN ROLE <span class="text-danger">*</span></label>
                    <InputSelect @bind-Value="model.RoleId" class="form-select">
                        <option value="0">-- Select Role --</option>
                        @foreach (var role in AllowedRoles)
                        {
                            <option value="@role.Id">@role.RoleName</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => model.RoleId)" />
                </div>

                <div class="form-check form-switch mb-4">
                    <InputCheckbox @bind-Value="model.IsActive" class="form-check-input" />
                    <label class="form-check-label fw-bold small">Active Status</label>
                </div>

                <div class="d-flex justify-content-end gap-2 pt-2 border-top">
                    <button type="button" class="btn btn-light text-muted" @onclick='() => Navigation.NavigateTo("/masters/temployee")'>Cancel</button>
                    <button type="submit" class="btn btn-success px-4" disabled="@isSaving">Save Assignment</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private TempEmployeeRoleVM model = new() { IsActive = true };
    private bool isSaving = false;
    private List<MasterRegion> Regions = new();
    private List<MasterLocation> Locations = new();
    private List<MasterRole> AllowedRoles = new();
    private int CurrentUserRoleId = 0;
    private int? CurrentUserRegionId = null;
    private int? CurrentUserLocationId = null;
    private bool isRegionalAdmin = false;
    private bool isStationAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        // Get current user session
        var userSession = await SessionService.GetUserSessionAsync();
        if (userSession != null)
        {
            var primaryRole = userSession.GetPrimaryRole();
            if (primaryRole != null)
            {
                CurrentUserRoleId = primaryRole.RoleId;
                CurrentUserRegionId = primaryRole.RegionId;
                CurrentUserLocationId = primaryRole.LocationId;
                
                // Check role type
                if (CurrentUserRoleId == 3)
                {
                    isRegionalAdmin = true;
                }
                else if (CurrentUserRoleId == 4)
                {
                    isStationAdmin = true;
                }
            }
        }

        // Load Regions
        var allRegions = await MasterService.GetAllRegionsAsync();
        
        // Filter regions based on role
        if (isRegionalAdmin && CurrentUserRegionId.HasValue)
        {
            Regions = allRegions.Where(r => r.Id == CurrentUserRegionId.Value).ToList();
            model.RegionId = CurrentUserRegionId.Value;
            Locations = await MasterService.GetLocationsByRegionAsync(CurrentUserRegionId.Value);
        }
        else if (isStationAdmin && CurrentUserRegionId.HasValue && CurrentUserLocationId.HasValue)
        {
            // Station Admin: Pre-select region and location
            Regions = allRegions.Where(r => r.Id == CurrentUserRegionId.Value).ToList();
            model.RegionId = CurrentUserRegionId.Value;
            
            var allLocations = await MasterService.GetLocationsByRegionAsync(CurrentUserRegionId.Value);
            Locations = allLocations.Where(l => l.Id == CurrentUserLocationId.Value).ToList();
            model.LocationId = CurrentUserLocationId.Value;
        }
        else
        {
            Regions = allRegions;
        }

        // Load and filter Roles from Database
        var allDbRoles = await _uow.MasterRoleDataRepository.GetAllAsync();

        // Filtering logic:
        if (CurrentUserRoleId == 1)
        {
            // Super Admin sees all roles
            AllowedRoles = allDbRoles.OrderBy(r => r.Id).ToList();
        }
        else if (CurrentUserRoleId == 2)
        {
            // Central Admin cannot see Super Admin (RoleId = 1)
            AllowedRoles = allDbRoles
                .Where(r => r.Id >= 2)
                .OrderBy(r => r.Id)
                .ToList();
        }
        else if (CurrentUserRoleId == 3)
        {
            // Regional Admin can only assign Regional Admin (3) and Station Admin (4)
            AllowedRoles = allDbRoles
                .Where(r => r.Id == 3 || r.Id == 4)
                .OrderBy(r => r.Id)
                .ToList();
        }
        else if (CurrentUserRoleId == 4)
        {
            // Station Admin can only assign Station Admin (4)
            AllowedRoles = allDbRoles
                .Where(r => r.Id == 4)
                .OrderBy(r => r.Id)
                .ToList();
        }
        else
        {
            // Others see their level or below
            AllowedRoles = allDbRoles
                .Where(r => r.Id >= CurrentUserRoleId)
                .OrderBy(r => r.Id)
                .ToList();
        }

        StateHasChanged();
    }

    private async Task OnRegionChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id) && id > 0)
        {
            model.RegionId = id;
            Locations = await MasterService.GetLocationsByRegionAsync(id);
            model.LocationId = 0;
        }
        else
        {
            model.RegionId = 0;
            Locations = new();
        }
    }

    private async Task Save()
    {
        if (model.RegionId == 0 || model.LocationId == 0 || model.RoleId == 0)
        {
            await JS.InvokeVoidAsync("alert", "Please fill all required fields.");
            return;
        }

        isSaving = true;
        var result = await Service.CreateAsync(model);
        if (result > 0)
        {
            await JS.InvokeVoidAsync("alert", "Role Added Successfully!");
            Navigation.NavigateTo("/masters/temployee");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Failed to add role.");
        }
        isSaving = false;
    }
}