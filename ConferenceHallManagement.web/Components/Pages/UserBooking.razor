@page "/book-hall"
@rendermode InteractiveServer

@using ConferenceHallManagement.web.ViewModels
@using ConferenceHallManagement.web.Services
@using ConferenceHallManagement.Web.Services
@using ConferenceHallManagement.Web.ViewModels
@using Models_ConferenceHallManagement.AppDbModels
@using BLL_ConferenceHallManagement
@using Repository_ConferenceHallManagement.AppDataRepositoy

@inject IUserBookingService BookingService
@inject IBllEmployee EmployeeService
@inject HallConfigurationService HallService
@inject IMasterRoomTypeBlazorService RoomTypeService
@inject IConferenceHallDataRepository HallRepository
@inject ICHBookingSessionsDataRepository BookingSessionRepo
@inject ICHSessionDataRepository SessionRepo
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime

<style>
    /* Reference-Based Card Styles */
    .book-hall-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        max-width: 720px;
        margin: 1.5rem auto;
    }

    .book-hall-header {
        background: linear-gradient(135deg, #4a5f8f 0%, #5d7bb8 100%);
        color: white;
        padding: 1rem 1.25rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 8px 8px 0 0;
    }

    .book-hall-body {
        padding: 1.25rem 1.25rem;
    }

    .form-group-custom {
        margin-bottom: 1rem;
    }

    .form-label-custom {
        font-size: 0.7rem;
        font-weight: 700;
        color: #2c3e50;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.4rem;
        display: block;
    }

    .required-asterisk {
        color: #dc3545;
        font-weight: bold;
        margin-left: 2px;
    }

    .form-control-custom, .form-select-custom {
        width: 100%;
        padding: 0.5rem 0.65rem;
        font-size: 0.85rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        font-family: inherit;
    }

    .form-control-custom:focus, .form-select-custom:focus {
        outline: none;
        border-color: #5d7bb8;
        box-shadow: 0 0 0 0.15rem rgba(93, 123, 184, 0.25);
    }

    .form-control-custom::placeholder {
        color: #6c757d;
        opacity: 0.7;
    }

    .is-invalid-custom {
        border-color: #dc3545 !important;
    }

    .validation-message {
        color: #dc3545;
        font-size: 0.7rem;
        margin-top: 0.25rem;
        display: block;
    }

    textarea.form-control-custom {
        resize: vertical;
        min-height: 70px;
    }

    .btn-check-availability {
        background: linear-gradient(135deg, #4a5f8f 0%, #5d7bb8 100%);
        color: white;
        border: none;
        padding: 0.65rem 1.5rem;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
        margin-top: 0.5rem;
    }

    .btn-check-availability:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 95, 143, 0.3);
    }

    .btn-check-availability:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-confirm-booking {
        background: linear-gradient(135deg, #4a5f8f 0%, #5d7bb8 100%);
        color: white;
        border: none;
        padding: 0.65rem 1.5rem;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-confirm-booking:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 95, 143, 0.3);
    }

    .btn-confirm-booking:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .date-input-wrapper {
        position: relative;
    }

    .date-input-wrapper i {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
        font-size: 0.85rem;
    }

    .session-table-container {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }

    .session-table-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.75rem;
    }

    .table-session-booking {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
    }

    .table-session-booking thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        text-align: left;
        padding: 0.6rem 0.5rem;
        border: 1px solid #dee2e6;
        font-size: 0.75rem;
    }

    .table-session-booking tbody td {
        padding: 0.6rem 0.5rem;
        border: 1px solid #dee2e6;
        vertical-align: middle;
    }

    .table-session-booking tbody tr:hover {
        background-color: #f8f9fa;
    }

    .form-check-session {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .form-check-session input[type="checkbox"] {
        margin-top: 0.25rem;
        width: 15px;
        height: 15px;
        cursor: pointer;
    }

    .form-check-session input[type="checkbox"]:disabled {
        cursor: not-allowed;
    }

    .form-check-label-session {
        flex: 1;
        font-size: 0.8rem;
    }

    .badge-available {
        background-color: #28a745;
        color: white;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-size: 0.65rem;
        font-weight: 600;
    }

    .badge-booked {
        background-color: #dc3545;
        color: white;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-size: 0.65rem;
        font-weight: 600;
    }

    .booked-info {
        margin-top: 0.4rem;
        padding-top: 0.4rem;
        border-top: 1px solid #dee2e6;
        font-size: 0.7rem;
        color: #dc3545;
    }

    .booked-info div {
        margin-bottom: 0.2rem;
    }

    .spinner-border-sm {
        width: 0.9rem;
        height: 0.9rem;
        border-width: 0.15rem;
    }

    /* Responsive adjustments for laptop screens */
    @@media (max-width: 1366px) {
        .book-hall-card {
            max-width: 680px;
            margin: 1rem auto;
        }
        
        .book-hall-body {
            padding: 1rem 1rem;
        }
    }

    @@media (max-width: 1024px) {
        .book-hall-card {
            max-width: 95%;
        }
    }
</style>

<div class="container-fluid mt-3">
    <div class="book-hall-card">
        <div class="book-hall-header">
            Book Hall
        </div>
        <div class="book-hall-body">
            <!-- Row 1: SELECT HALL & NO. OF ATTENDEES -->
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            SELECT HALL <span class="required-asterisk">*</span>
                        </label>
                        <select class="form-select-custom @(ShowValidation && SelectedHallId == 0 ? "is-invalid-custom" : "")" 
                                @bind="SelectedHallId" 
                                @oninput="ClearValidation">
                            <option value="0">Select Hall</option>
                            @foreach (var hall in FilteredHalls)
                            {
                                <option value="@hall.HallId">@hall.HallNameEn (Capacity: @hall.Capacity)</option>
                            }
                        </select>
                        @if (ShowValidation && SelectedHallId == 0)
                        {
                            <span class="validation-message">Please select a conference hall</span>
                        }
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            NO. OF ATTENDEES <span class="required-asterisk">*</span>
                        </label>
                        <input type="number" 
                               class="form-control-custom @(ShowValidation && NumberOfAttendees <= 0 ? "is-invalid-custom" : "")" 
                               @bind="NumberOfAttendees" 
                               @oninput="ClearValidation"
                               placeholder="0" 
                               min="1" />
                        @if (ShowValidation && NumberOfAttendees <= 0)
                        {
                            <span class="validation-message">Please enter number of attendees</span>
                        }
                    </div>
                </div>
            </div>

            <!-- Row 2: MEETING PURPOSE & ROOM TYPE -->
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            MEETING PURPOSE (PROGRAM NAME) <span class="required-asterisk">*</span>
                        </label>
                        <input type="text" 
                               class="form-control-custom @(ShowValidation && string.IsNullOrWhiteSpace(ProgramName) ? "is-invalid-custom" : "")" 
                               @bind="ProgramName" 
                               @oninput="ClearValidation"
                               placeholder="Enter Purpose" />
                        @if (ShowValidation && string.IsNullOrWhiteSpace(ProgramName))
                        {
                            <span class="validation-message">Please enter the purpose of booking</span>
                        }
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            ROOM TYPE <span class="required-asterisk">*</span>
                        </label>
                        <select class="form-select-custom @(ShowValidation && SelectedRoomTypeId == 0 ? "is-invalid-custom" : "")" 
                                @bind="SelectedRoomTypeId"
                                @oninput="ClearValidation">
                            <option value="0">Select Type</option>
                            @foreach (var roomType in RoomTypes)
                            {
                                <option value="@roomType.RoomTypeId">@roomType.RoomTypeEn</option>
                            }
                        </select>
                        @if (ShowValidation && SelectedRoomTypeId == 0)
                        {
                            <span class="validation-message">Please select a room type</span>
                        }
                    </div>
                </div>
            </div>

            <!-- Row 3: REMARKS -->
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group-custom">
                        <label class="form-label-custom">REMARKS</label>
                        <textarea class="form-control-custom" 
                                  @bind="Remarks" 
                                  placeholder="Any special requirements"></textarea>
                    </div>
                </div>
            </div>

            <!-- Row 4: FROM DATE & TO DATE -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            FROM DATE <span class="required-asterisk">*</span>
                        </label>
                        <div class="date-input-wrapper">
                            <input type="date" 
                                   class="form-control-custom @(ShowValidation && !IsValidStartDate() ? "is-invalid-custom" : "")" 
                                   @bind="StartDate"
                                   @oninput="ClearValidation" />
                            <i class="bi bi-calendar3"></i>
                        </div>
                        @if (ShowValidation && !IsValidStartDate())
                        {
                            <span class="validation-message">Please select a valid start date</span>
                        }
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            TO DATE <span class="required-asterisk">*</span>
                        </label>
                        <div class="date-input-wrapper">
                            <input type="date" 
                                   class="form-control-custom @(ShowValidation && !IsValidEndDate() ? "is-invalid-custom" : "")" 
                                   @bind="EndDate"
                                   @oninput="ClearValidation" />
                            <i class="bi bi-calendar3"></i>
                        </div>
                        @if (ShowValidation && !IsValidEndDate())
                        {
                            <span class="validation-message">End date must be greater than or equal to start date</span>
                        }
                    </div>
                </div>
            </div>

            <!-- Check Availability Button -->
            <div class="row">
                <div class="col-md-12">
                    <button class="btn-check-availability" @onclick="HandleCheckAvailability" disabled="@IsLoading">
                        @if (IsLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Checking...</span>
                        }
                        else
                        {
                            <span>Check Availability</span>
                        }
                    </button>
                </div>
            </div>

            @if (DaySchedules != null && DaySchedules.Any())
            {
                <div class="session-table-container">
                    <h6 class="session-table-title">Select Sessions</h6>
                    <div class="table-responsive">
                        <table class="table-session-booking">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Date</th>
                                    @foreach (var session in HallSessions)
                                    {
                                        <th>@session.SessionEn</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var schedule in DaySchedules)
                                {
                                    <tr>
                                        <td class="fw-bold">@schedule.Date.ToString("dd-MMM-yyyy (ddd)")</td>

                                        @foreach (var sessionSlot in schedule.Sessions)
                                        {
                                            <td>
                                                <div class="form-check-session">
                                                    <input type="checkbox"
                                                           @bind="sessionSlot.IsSelected"
                                                           disabled="@sessionSlot.IsBooked"
                                                           id="@($"session_{schedule.Date.Ticks}_{sessionSlot.SessionId}")" />
                                                    <label class="form-check-label-session" for="@($"session_{schedule.Date.Ticks}_{sessionSlot.SessionId}")">
                                                        <div>
                                                            @sessionSlot.Label
                                                            @if (sessionSlot.IsBooked)
                                                            {
                                                                <span class="badge-booked ms-2">Booked</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge-available ms-2">Available</span>
                                                            }
                                                        </div>
                                                        @if (sessionSlot.IsBooked)
                                                        {
                                                            <div class="booked-info">
                                                                <div>
                                                                    <i class="bi bi-person-fill"></i> <strong>@sessionSlot.BookedByName</strong>
                                                                </div>
                                                                <div>
                                                                    <i class="bi bi-telephone-fill"></i> @sessionSlot.BookedByPhone
                                                                </div>
                                                            </div>
                                                        }
                                                    </label>
                                                </div>
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-end mt-3">
                        <button class="btn-confirm-booking" @onclick="ConfirmBooking" disabled="@IsSaving">
                            @if (IsSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Processing...</span>
                            }
                            else
                            {
                                <span>Confirm Booking</span>
                            }
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    // --- HELPER CLASSES ---
    public class DaySchedule
    {
        public DateTime Date { get; set; }
        public List<SlotItem> Sessions { get; set; } = new();
    }

    public class SlotItem
    {
        public int SessionId { get; set; }
        public string Label { get; set; } = string.Empty;
        public bool IsSelected { get; set; }
        public bool IsBooked { get; set; }
        public string BookedByName { get; set; } = string.Empty;
        public string BookedByPhone { get; set; } = string.Empty;
    }

    // --- VARIABLES ---
    private List<MasterRoomTypeVM> RoomTypes { get; set; } = new();
    private List<ConferenceHall> AllHalls { get; set; } = new();
    private List<ConferenceHall> FilteredHalls { get; set; } = new();
    private List<ConferenceHallSession> HallSessions { get; set; } = new();
    private int SelectedRoomTypeId { get; set; } = 0;
    private int SelectedHallId { get; set; }
    private string ProgramName { get; set; } = "";
    private int NumberOfAttendees { get; set; }
    private string Remarks { get; set; } = "";
    private DateTime StartDate { get; set; } = DateTime.Today;
    private DateTime EndDate { get; set; } = DateTime.Today;

    private string LoggedInUser { get; set; } = "";
    private string UserPhone { get; set; } = "";

    private List<DaySchedule> DaySchedules { get; set; } = new();
    private bool IsLoading { get; set; } = false;
    private bool IsSaving { get; set; } = false;
    private bool ShowValidation { get; set; } = false;

    // --- ON LOAD: Fetch User Data, Room Types and Active Halls ---
    protected override async Task OnInitializedAsync()
    {
        try
        {
            string mockLoggedInId = "60020656";
            var empData = await EmployeeService.GetEmployeeByUserName(mockLoggedInId);

            if (empData != null)
            {
                LoggedInUser = empData.Empname;
                UserPhone = empData.Cellno;
            }

            var roomTypeList = await RoomTypeService.GetAllAsync();
            RoomTypes = roomTypeList.ToList();

            AllHalls = await HallRepository.GetAllHallsAsync();
            FilteredHalls = AllHalls.Where(h => h.Status).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error fetching data: " + ex.Message);
        }
    }

    // --- VALIDATION METHODS ---
    private bool IsValidStartDate()
    {
        return StartDate != default(DateTime);
    }

    private bool IsValidEndDate()
    {
        return EndDate != default(DateTime) && EndDate >= StartDate;
    }

    private bool ValidateForm()
    {
        if (SelectedHallId == 0)
            return false;

        if (SelectedRoomTypeId == 0)
            return false;

        if (string.IsNullOrWhiteSpace(ProgramName))
            return false;

        if (NumberOfAttendees <= 0)
            return false;

        if (!IsValidStartDate())
            return false;

        if (!IsValidEndDate())
            return false;

        return true;
    }

    private void ClearValidation()
    {
        ShowValidation = false;
    }

    // --- CHECK AVAILABILITY WITH DYNAMIC SESSIONS FROM DATABASE ---
    private async Task HandleCheckAvailability()
    {
        // Validate all required fields
        if (!ValidateForm())
        {
            ShowValidation = true;
            await JSRuntime.InvokeVoidAsync("alert", "Please fill all required fields marked with * before checking availability.");
            return;
        }

        IsLoading = true;
        DaySchedules = new();
        HallSessions = new();

        try
        {
            // Get all sessions for the selected hall from database
            var sessionsFromDb = await SessionRepo.GetConferenceHallSessionByHallId(SelectedHallId);
            HallSessions = sessionsFromDb.Where(s => s.Status).ToList();

            if (!HallSessions.Any())
            {
                await JSRuntime.InvokeVoidAsync("alert", "No sessions are configured for this hall. Please contact the administrator.");
                IsLoading = false;
                return;
            }

            // Loop through date range
            for (var currentDate = StartDate.Date; currentDate <= EndDate.Date; currentDate = currentDate.AddDays(1))
            {
                var daySchedule = new DaySchedule
                {
                    Date = currentDate,
                    Sessions = new List<SlotItem>()
                };

                // Loop through each session configured for this hall
                foreach (var session in HallSessions)
                {
                    var slotItem = new SlotItem
                    {
                        SessionId = session.SessionId,
                        Label = session.SessionEn,
                        IsSelected = false,
                        IsBooked = false,
                        BookedByName = "",
                        BookedByPhone = ""
                    };

                    // Check if this session slot is already booked for this date
                    var existingBooking = await BookingSessionRepo.GetConferenceHallSessionBookingDetails(
                        SelectedHallId, 
                        session.SessionId, 
                        currentDate);

                    if (existingBooking != null)
                    {
                        slotItem.IsBooked = true;

                        // Extract user details from the booking
                        if (existingBooking.Booking != null)
                        {
                            slotItem.BookedByName = existingBooking.Booking.CreatedBy ?? "Unknown User";

                            // Extract phone from Remarks (format: "Phone: XXXXXXXXXX | remarks")
                            var remarks = existingBooking.Booking.Remarks ?? "";
                            if (remarks.Contains("Phone:"))
                            {
                                var phoneStart = remarks.IndexOf("Phone:") + 6;
                                var phoneEnd = remarks.IndexOf("|", phoneStart);
                                if (phoneEnd > phoneStart)
                                {
                                    slotItem.BookedByPhone = remarks.Substring(phoneStart, phoneEnd - phoneStart).Trim();
                                }
                                else
                                {
                                    slotItem.BookedByPhone = remarks.Substring(phoneStart).Trim();
                                }
                            }
                            else
                            {
                                slotItem.BookedByPhone = "N/A";
                            }
                        }
                    }

                    daySchedule.Sessions.Add(slotItem);
                }

                DaySchedules.Add(daySchedule);
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Error checking availability: " + ex.Message);
        }
        finally
        {
            IsLoading = false;
        }
    }

    // --- CONFIRM BOOKING ---
    private async Task ConfirmBooking()
    {
        // 1. Validate Hall Selected
        if (SelectedHallId == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please select a hall!");
            return;
        }

        // 2. Validate Purpose Filled
        if (string.IsNullOrEmpty(ProgramName))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please enter Meeting Purpose!");
            return;
        }

        // 3. Validate User Data Loaded
        if (string.IsNullOrEmpty(LoggedInUser))
        {
            await JSRuntime.InvokeVoidAsync("alert", "User Data Error: Could not fetch employee details. Cannot proceed.");
            return;
        }

        // 4. Validate at least one slot selected
        bool hasSelection = DaySchedules.Any(d => d.Sessions.Any(s => s.IsSelected));
        if (!hasSelection)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please select at least one session to book!");
            return;
        }

        IsSaving = true;
        try
        {
            // Convert DaySchedules to BookingDayVM format expected by SaveBookingAsync
            var availabilityList = DaySchedules.Select(day => new BookingDayVM
            {
                Date = day.Date,
                Sessions = new List<BookingSessionVM>()
            }).ToList();

            for (int i = 0; i < DaySchedules.Count; i++)
            {
                foreach (var sessionSlot in DaySchedules[i].Sessions)
                {
                    if (sessionSlot.IsSelected)
                    {
                        availabilityList[i].Sessions.Add(new BookingSessionVM
                        {
                            SessionId = sessionSlot.SessionId,
                            SessionName = sessionSlot.Label,
                            IsSelected = true
                        });
                    }
                }
            }

            bool success = await BookingService.SaveBookingAsync(
                SelectedHallId,
                ProgramName,
                NumberOfAttendees,
                Remarks,
                LoggedInUser,
                UserPhone,
                availabilityList
            );

            if (success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Booking Successful!");
                NavManager.NavigateTo("/my-bookings", true);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Booking Failed! One or more slots may already be occupied. Please try again.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Error: " + ex.Message);
        }
        finally
        {
            IsSaving = false;
        }
    }
}