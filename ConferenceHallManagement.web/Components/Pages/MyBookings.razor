@page "/my-bookings"
@rendermode InteractiveServer

@using ConferenceHallManagement.web.ViewModels
@using ConferenceHallManagement.web.Services
@using ConferenceHallManagement.Web.Services
@using BLL_ConferenceHallManagement

@inject IUserBookingService BookingService
@inject IBllEmployee EmployeeService
@inject UserSessionService UserSession
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime

<style>
    .my-bookings-container {
        padding: 1.5rem;
        max-width: 800px;
        margin: 0 auto;
    }

    .page-header {
        background: linear-gradient(135deg, #4a5f8f 0%, #5d7bb8 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .page-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .btn-create-new {
        background: white;
        color: #4a5f8f;
        border: none;
        padding: 0.5rem 1.25rem;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-create-new:hover {
        background: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .booking-card {
        background: white;
        border: 2px solid #5d7bb8;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1.25rem;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
    }

    .booking-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(93, 123, 184, 0.2);
    }

    .card-header-section {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .hall-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .room-type-badge {
        display: inline-block;
        background: #e8f4f8;
        color: #0277bd;
        padding: 0.35rem 0.85rem;
        border-radius: 16px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .sessions-count {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }

    .card-menu-container {
        position: relative;
    }

    .card-menu-btn {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        color: #6c757d;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        line-height: 1;
    }

    .card-menu-btn:hover {
        color: #2c3e50;
    }

    .card-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 140px;
        z-index: 1000;
        overflow: hidden;
    }

    .card-menu-dropdown button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.65rem 1rem;
        border: none;
        background: white;
        text-align: left;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background 0.2s;
    }

    .card-menu-dropdown button:hover:not(:disabled) {
        background: #f8f9fa;
    }

    .card-menu-dropdown button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .card-menu-dropdown button i {
        font-size: 1rem;
    }

    .menu-item-view {
        color: #0d6efd;
    }

    .menu-item-delete {
        color: #dc3545;
    }

    .date-section {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .date-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: #2c3e50;
    }

    .date-separator {
        width: 25px;
        height: 2px;
        background: linear-gradient(to right, #ffc107, #ff9800);
        border-radius: 2px;
    }

    .card-info-section {
        margin-bottom: 0;
    }

    .info-row {
        display: flex;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .info-label {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 600;
        min-width: 110px;
    }

    .info-value {
        font-size: 0.875rem;
        color: #2c3e50;
        font-weight: 500;
        flex: 1;
    }

    .program-name-value {
        font-weight: 700;
        color: #000;
    }

    .attendees-value {
        font-weight: 700;
        color: #000;
    }

    .info-row-with-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .info-row-left {
        display: flex;
        flex: 1;
    }

    .status-badge {
        padding: 0.5rem 1.25rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        min-width: 130px;
        margin-left: 1rem;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-approved {
        background: #d4edda;
        color: #155724;
    }

    .status-auto-approved {
        background: #d1ecf1;
        color: #0c5460;
    }

    .status-cancelled {
        background: #f8d7da;
        color: #721c24;
    }

    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }

    .status-partially-approved {
        background: #fff3cd;
        color: #856404;
    }

    /* Modal Styles */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        display: block;
    }

    .modal-dialog-custom {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 700px;
        z-index: 1050;
    }

    .modal-content-custom {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }

    .modal-header-custom {
        background: linear-gradient(135deg, #4a5f8f 0%, #5d7bb8 100%);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
    }

    .btn-close-modal {
        background: transparent;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-body-custom {
        padding: 1.5rem;
        max-height: 70vh;
        overflow-y: auto;
    }

    .detail-row {
        margin-bottom: 1rem;
    }

    .detail-label {
        font-size: 0.7rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .detail-value {
        font-size: 0.95rem;
        color: #212529;
        font-weight: 400;
    }

    .detail-value-highlight {
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .sessions-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 1.5rem 0 1rem 0;
        padding-top: 1rem;
        border-top: 2px solid #e9ecef;
    }

    .session-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }

    .session-table th {
        background: #f8f9fa;
        padding: 0.6rem 0.5rem;
        text-align: center;
        font-weight: 600;
        border: 1px solid #dee2e6;
    }

    .session-table td {
        padding: 0.6rem 0.5rem;
        text-align: center;
        border: 1px solid #dee2e6;
    }

    .session-status-badge {
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }

    .modal-footer-custom {
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        display: flex;
        justify-content: flex-end;
    }

    .btn-close-footer {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.5rem 1.5rem;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-close-footer:hover {
        background: #5a6268;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .loading-state {
        text-align: center;
        padding: 3rem 1rem;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3rem;
    }
</style>

<div class="my-bookings-container">
    <div class="page-header">
        <h1 class="page-title">My Bookings</h1>
        <button class="btn-create-new" @onclick="GoToCreate">
            <i class="bi bi-plus-lg"></i>
            <span>Create New</span>
        </button>
    </div>

    @if (IsLoading)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Loading your bookings...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Error</h5>
            <p>@ErrorMessage</p>
            <button class="btn btn-primary mt-2" @onclick="LoadBookings">Retry</button>
        </div>
    }
    else if (BookingsList == null || !BookingsList.Any())
    {
        <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p class="mt-3">You haven't made any bookings yet.</p>
        </div>
    }
    else
    {
        @foreach (var item in BookingsList)
        {
            bool isExpired = false;
            if (item.SessionDetails != null && item.SessionDetails.Any())
            {
                if (item.SessionDetails.All(s => s.Date.Date < DateTime.Today)) isExpired = true;
            }
            else
            {
                if (DateTime.TryParse(item.ToDate, out DateTime endDate))
                {
                    if (endDate.Date < DateTime.Today) isExpired = true;
                }
            }
            if (item.ActiveSessionsCount == 0) isExpired = true;

            <div class="booking-card">
                <!-- Card Header -->
                <div class="card-header-section">
                    <div>
                        <div class="hall-title">@item.HallName</div>
                        <div class="room-type-badge">@item.SeatingType</div>
                        <div class="sessions-count">Sessions: @item.ActiveSessionsCount</div>
                    </div>
                    <div class="card-menu-container">
                        <button class="card-menu-btn" @onclick="() => ToggleMenu(item.BookingId)">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        @if (OpenMenuBookingId == item.BookingId)
                        {
                            <div class="card-menu-dropdown" @onclick:stopPropagation="true">
                                <button class="menu-item-view" @onclick="() => { OpenDetails(item); CloseMenu(); }">
                                    <i class="bi bi-eye"></i> View
                                </button>
                                <button class="menu-item-delete" 
                                        @onclick="() => { CancelBooking(item); CloseMenu(); }"
                                        disabled="@isExpired">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        }
                    </div>
                </div>

                <!-- Date Section - Simplified -->
                <div class="date-section">
                    <div class="date-value">@item.FromDate</div>
                    <div class="date-separator"></div>
                    <div class="date-value">@item.ToDate</div>
                </div>

                <!-- Info Section with Status on Right -->
                <div class="card-info-section">
                    <div class="info-row">
                        <span class="info-label">Program Name:</span>
                        <span class="info-value program-name-value">@item.ProgramName</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Attendees:</span>
                        <span class="info-value attendees-value">@item.Attendees</span>
                    </div>
                    <div class="info-row-with-status">
                        <div class="info-row-left">
                            <span class="info-label">Remarks:</span>
                            <span class="info-value">@GetCleanRemark(item.Remarks)</span>
                        </div>
                        @{
                            var statusInfo = GetBookingStatus(item);
                        }
                        <div class="status-badge @statusInfo.StatusClass">
                            @statusInfo.StatusText
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@if (ShowModal && SelectedBooking != null)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-dialog-custom" @onclick:stopPropagation="true">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h5 class="modal-title">
                    <i class="bi bi-eye me-2"></i>Booking Details
                </h5>
                <button class="btn-close-modal" @onclick="CloseModal">×</button>
            </div>
            <div class="modal-body-custom">
                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-row">
                            <div class="detail-label">Hall Name</div>
                            <div class="detail-value" style="color: #0d6efd; font-weight: 600;">@SelectedBooking.HallName</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-row">
                            <div class="detail-label">Room Type</div>
                            <div class="detail-value">@SelectedBooking.SeatingType</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-row">
                            <div class="detail-label">Program Name</div>
                            <div class="detail-value">@SelectedBooking.ProgramName</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-row">
                            <div class="detail-label">Number of Attendees</div>
                            <div class="detail-value">@SelectedBooking.Attendees</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-row">
                            <div class="detail-label">From Date</div>
                            <div class="detail-value">@SelectedBooking.FromDate</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-row">
                            <div class="detail-label">To Date</div>
                            <div class="detail-value">@SelectedBooking.ToDate</div>
                        </div>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Remarks</div>
                    <div class="detail-value detail-value-highlight">
                        @GetCleanRemark(SelectedBooking.Remarks)
                    </div>
                </div>

                <h6 class="sessions-title">Session Breakdown (@SelectedBooking.ActiveSessionsCount Active)</h6>

                @if (SelectedBooking.SessionDetails != null && SelectedBooking.SessionDetails.Any())
                {
                    <table class="session-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Slot</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var session in SelectedBooking.SessionDetails)
                            {
                                bool isPastDate = session.Date.Date < DateTime.Today;
                                
                                <tr>
                                    <td>@session.DisplayDate</td>
                                    <td>@session.SessionTime</td>
                                    <td>
                                        @if (isPastDate && session.StatusCode == 1)
                                        {
                                            <span class="session-status-badge" style="background: #d1ecf1; color: #0c5460;">Auto Approved</span>
                                        }
                                        else if (session.StatusCode == 2)
                                        {
                                            <span class="session-status-badge" style="background: #d4edda; color: #155724;">Approved</span>
                                        }
                                        else if (session.StatusCode == 1)
                                        {
                                            <span class="session-status-badge" style="background: #fff3cd; color: #856404;">Pending</span>
                                        }
                                        else if (session.StatusCode == 4)
                                        {
                                            <span class="session-status-badge" style="background: #f8d7da; color: #721c24;">Rejected</span>
                                        }
                                        else if (session.StatusCode == 3)
                                        {
                                            <span class="session-status-badge" style="background: #e2e3e5; color: #383d41;">Cancelled</span>
                                        }
                                        else
                                        {
                                            <span class="session-status-badge" style="background: #e2e3e5; color: #383d41;">@session.Status</span>
                                        }
                                    </td>
                                    <td>
                                        @if (session.Date >= DateTime.Today && session.StatusCode != 3 && session.StatusCode != 4)
                                        {
                                            <button class="btn btn-outline-danger btn-sm py-0 px-2" @onclick="() => CancelSpecificSession(session.RecordId)">
                                                <i class="bi bi-x"></i> Cancel
                                            </button>
                                        }
                                        else if (isPastDate)
                                        {
                                            <span class="badge bg-secondary">Completed</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="text-center text-muted py-3">No active sessions found.</div>
                }
            </div>
            <div class="modal-footer-custom">
                <button class="btn-close-footer" @onclick="CloseModal">Close</button>
            </div>
        </div>
    </div>
}

@code {
    private List<BookingListVM> BookingsList { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private bool ShowModal { get; set; } = false;
    private BookingListVM? SelectedBooking { get; set; }
    private string? ErrorMessage { get; set; }
    private int? OpenMenuBookingId { get; set; } = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadBookings();
    }

    private async Task LoadBookings()
    {
        IsLoading = true;
        ErrorMessage = null;
        
        try
        {
            var username = await UserSession.GetEmpId();
            
            if (string.IsNullOrEmpty(username))
            {
                ErrorMessage = "Unable to retrieve username from session. Please log out and log back in.";
                return;
            }
            
            BookingsList = await BookingService.GetMyBookingsAsync(username);
        }
        catch (Exception ex) 
        { 
            ErrorMessage = $"Error loading bookings: {ex.Message}";
            Console.WriteLine($"Error in LoadBookings: {ex.ToString()}");
        }
        finally 
        { 
            IsLoading = false; 
        }
    }

    private string GetCleanRemark(string rawRemark)
    {
        if (string.IsNullOrEmpty(rawRemark)) return "-";
        string cleanRemark = rawRemark;
        if (cleanRemark.Contains("|")) { var parts = cleanRemark.Split('|'); cleanRemark = parts.LastOrDefault()?.Trim() ?? ""; }
        else if (cleanRemark.Trim().StartsWith("Phone:")) { return "-"; }
        int bracketIndex = cleanRemark.IndexOf("[");
        if (bracketIndex > 0) { cleanRemark = cleanRemark.Substring(0, bracketIndex).Trim(); }
        return string.IsNullOrWhiteSpace(cleanRemark) ? "-" : cleanRemark;
    }

    private (string StatusText, string StatusClass) GetBookingStatus(BookingListVM item)
    {
        if (item.SessionDetails == null || !item.SessionDetails.Any())
        {
            return ("Pending", "status-pending");
        }

        // Filter only active sessions (future dates or today)
        var activeSessions = item.SessionDetails.Where(s => s.Date.Date >= DateTime.Today).ToList();
        
        // If no active sessions, check past sessions to determine completed status
        if (!activeSessions.Any())
        {
            var pastSessions = item.SessionDetails.Where(s => s.Date.Date < DateTime.Today).ToList();
            if (pastSessions.Any())
            {
                var allApproved = pastSessions.All(s => s.StatusCode == 2);
                if (allApproved)
                {
                    return ("Approved", "status-approved");
                }
            }
            return ("Completed", "status-approved");
        }

        // Count session statuses for active sessions only
        var approvedCount = activeSessions.Count(s => s.StatusCode == 2);
        var rejectedCount = activeSessions.Count(s => s.StatusCode == 4);
        var pendingCount = activeSessions.Count(s => s.StatusCode == 1);
        var cancelledCount = activeSessions.Count(s => s.StatusCode == 3);

        // All approved
        if (approvedCount == activeSessions.Count)
        {
            return ("Approved", "status-approved");
        }
        // All rejected
        else if (rejectedCount == activeSessions.Count)
        {
            return ("Rejected", "status-rejected");
        }
        // All cancelled
        else if (cancelledCount == activeSessions.Count)
        {
            return ("Cancelled", "status-cancelled");
        }
        // Mix of approved and rejected/pending
        else if (approvedCount > 0 && (rejectedCount > 0 || pendingCount > 0))
        {
            return ("Partially Approved", "status-partially-approved");
        }
        // Mix of rejected and pending
        else if (rejectedCount > 0 && pendingCount > 0)
        {
            return ("Partially Approved", "status-partially-approved");
        }
        // All pending
        else if (pendingCount > 0)
        {
            return ("Pending", "status-pending");
        }

        return ("Partially Approved", "status-partially-approved");
    }

    private void ToggleMenu(int bookingId)
    {
        if (OpenMenuBookingId == bookingId)
        {
            OpenMenuBookingId = null;
        }
        else
        {
            OpenMenuBookingId = bookingId;
        }
    }

    private void CloseMenu()
    {
        OpenMenuBookingId = null;
    }

    private void OpenDetails(BookingListVM item) 
    { 
        SelectedBooking = item; 
        ShowModal = true;
        CloseMenu();
    }

    private void CloseModal() 
    { 
        ShowModal = false; 
        SelectedBooking = null; 
    }

    private void GoToCreate() { NavManager.NavigateTo("/book-hall"); }

    private async Task CancelBooking(BookingListVM item)
    {
        CloseMenu();
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this entire booking? All active sessions will be cancelled.");
        if (confirm)
        {
            bool success = await BookingService.CancelBookingAsync(item.BookingId);
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Booking cancelled successfully!");
                await LoadBookings();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to cancel booking. Please try again.");
            }
        }
    }

    private async Task CancelSpecificSession(int sessionRecordId)
    {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Cancel session?");
        if (confirm)
        {
            await BookingService.CancelSessionAsync(sessionRecordId);
            await LoadBookings();
            if (SelectedBooking != null)
            {
                var updated = BookingsList.FirstOrDefault(b => b.BookingId == SelectedBooking.BookingId);
                if (updated == null || updated.ActiveSessionsCount == 0) CloseModal(); else SelectedBooking = updated;
            }
        }
    }
}