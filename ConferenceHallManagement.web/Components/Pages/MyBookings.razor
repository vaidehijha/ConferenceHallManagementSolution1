@page "/my-bookings"
@rendermode InteractiveServer

@using ConferenceHallManagement.web.ViewModels
@using ConferenceHallManagement.web.Services
@using ConferenceHallManagement.Web.Services
@using BLL_ConferenceHallManagement

@inject IUserBookingService BookingService
@inject IBllEmployee EmployeeService
@inject UserSessionService UserSession
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime

<style>
    .powergrid-table {
        font-size: 0.85rem;
    }

        .powergrid-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            padding: 10px 5px;
            white-space: nowrap;
        }

        .powergrid-table td {
            vertical-align: middle;
            border: 1px solid #dee2e6;
            padding: 8px 5px;
            color: #000;
        }

    .hall-name {
        font-weight: 700;
        color: #2c3e50;
        font-size: 0.9rem;
        display: block;
    }

    .program-name {
        font-weight: 600;
        color: #212529;
    }

    .remarks-text {
        color: #212529;
        font-size: 0.85rem;
        font-weight: 400;
    }

    .btn-icon {
        border: none;
        background: transparent;
        padding: 4px;
        transition: transform 0.2s;
        font-size: 1.1rem;
    }

    .btn-view {
        color: #0d6efd;
    }

        .btn-view:hover {
            transform: scale(1.1);
        }

    .btn-delete {
        color: #dc3545;
    }

        .btn-delete:hover {
            transform: scale(1.1);
        }

    .btn-disabled {
        color: #cccccc !important;
        cursor: not-allowed;
        pointer-events: none;
    }

    .status-badge {
        font-size: 0.7rem;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 500;
    }

    .detail-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
    }

    .detail-value {
        font-size: 0.95rem;
        color: #212529;
        font-weight: 400;
        margin-bottom: 1rem;
    }

    .modal-header-custom {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem 1.5rem;
    }
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0 fw-bold text-dark" style="border-left: 5px solid #0d6efd; padding-left: 10px;">
            My Bookings
        </h4>
        <button class="btn btn-warning text-dark fw-bold shadow-sm px-4" @onclick="GoToCreate">
            <i class="bi bi-plus-lg me-2"></i>Create New
        </button>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            @if (IsLoading)
            {
                <div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Loading your bookings...</p></div>
            }
            else if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger m-3">
                    <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Error</h5>
                    <p>@ErrorMessage</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" @onclick="LoadBookings">Retry</button>
                    </div>
                </div>
            }
            else if (BookingsList == null || !BookingsList.Any())
            {
                <div class="text-center p-5 text-muted">
                    <i class="bi bi-calendar-x fs-1"></i>
                    <p class="mt-3">You haven't made any bookings yet.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover powergrid-table mb-0">
                        <thead>
                            <tr>
                                <th style="width: 18%;">Hall Details</th>
                                <th style="width: 10%;">Room Type</th>
                                <th style="width: 15%;">Program Name</th>
                                <th style="width: 5%;">Att.</th>
                                <th style="width: 20%;">Remarks</th>
                                <th style="width: 8%;">From</th>
                                <th style="width: 8%;">To</th>
                                <th style="width: 9%;">Status</th>
                                <th style="width: 7%;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in BookingsList)
                            {
                                bool isExpired = false;
                                if (item.SessionDetails != null && item.SessionDetails.Any())
                                {
                                    if (item.SessionDetails.All(s => s.Date.Date < DateTime.Today)) isExpired = true;
                                }
                                else
                                {
                                    if (DateTime.TryParse(item.ToDate, out DateTime endDate))
                                    {
                                        if (endDate.Date < DateTime.Today) isExpired = true;
                                    }
                                }
                                if (item.ActiveSessionsCount == 0) isExpired = true;

                                <tr>
                                    <td><div class="hall-name">@item.HallName</div><small class="text-muted">Sessions: @item.ActiveSessionsCount</small></td>
                                    <td class="text-center">@item.SeatingType</td>
                                    <td><div class="program-name">@item.ProgramName</div></td>
                                    <td class="text-center">@item.Attendees</td>
                                    <td><span class="remarks-text text-break">@GetCleanRemark(item.Remarks)</span></td>
                                    <td class="text-center">@item.FromDate</td>
                                    <td class="text-center">@item.ToDate</td>
                                    <td class="text-center">
                                        @{
                                            string badgeClass = item.BookingStatus.Contains("Pending") ? "bg-warning text-dark" : item.BookingStatus.Contains("Cancel") ? "bg-danger" : (item.BookingStatus.Contains("Approved") || item.BookingStatus.Contains("Auto")) ? "bg-success" : "bg-secondary";
                                        }
                                        <span class="badge @badgeClass status-badge">@item.BookingStatus</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center gap-1">
                                            <button class="btn btn-icon btn-view" title="View Details" @onclick="() => OpenDetails(item)"><i class="bi bi-eye"></i></button>
                                            <button class="btn btn-icon @(isExpired ? "btn-disabled" : "btn-delete")"
                                                    title="@(isExpired ? "Booking Passed/Completed" : "Delete Booking")"
                                                    @onclick="() => CancelBooking(item)"
                                                    disabled="@isExpired">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@if (ShowModal && SelectedBooking != null)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header-custom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-eye me-2"></i>Booking Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-md-6"><div class="detail-label">Hall Name</div><div class="detail-value">@SelectedBooking.HallName</div></div>
                        <div class="col-md-6"><div class="detail-label">Room Type</div><div class="detail-value">@SelectedBooking.SeatingType</div></div>
                    </div>
                    <div class="row">
                        <div class="col-12"><div class="detail-label">Remarks</div><div class="detail-value bg-light p-2 rounded border">@GetCleanRemark(SelectedBooking.Remarks)</div></div>
                    </div>

                    <hr class="my-4" />
                    <h6 class="fw-bold mb-3 text-secondary">Session Details (@SelectedBooking.ActiveSessionsCount)</h6>

                    <div class="table-responsive">
                        <table class="table table-sm table-bordered text-center align-middle">
                            <thead class="table-light"><tr><th>Date</th><th>Slot</th><th>Status</th><th>Action</th></tr></thead>
                            <tbody>
                                @if (SelectedBooking.SessionDetails != null && SelectedBooking.SessionDetails.Any())
                                {
                                    foreach (var session in SelectedBooking.SessionDetails)
                                    {
                                        <tr>
                                            <td>@session.DisplayDate</td>
                                            <td>@session.SessionTime</td>
                                            <td>
                                                @if (session.Date < DateTime.Today)
                                                {
                                                    <span class="badge bg-secondary">Completed</span>
                                                }
                                                else
                                                {

                                                    <span class="badge bg-success">Active</span>
                                                }
                                            </td>
                                            <td>
                                                @if (session.Date >= DateTime.Today)
                                                {
                                                    <button class="btn btn-outline-danger btn-sm py-0 px-2" @onclick="() => CancelSpecificSession(session.RecordId)"><i class="bi bi-x"></i> Cancel</button>
                                                }
                                                else
                                                {

                                                    <span class="text-muted small">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="4" class="text-muted">No active sessions found.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0">
                    <button class="btn btn-secondary px-4 fw-bold" @onclick="CloseModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<BookingListVM> BookingsList { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private bool ShowModal { get; set; } = false;
    private BookingListVM? SelectedBooking { get; set; }
    private string? ErrorMessage { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadBookings();
    }

    private async Task LoadBookings()
    {
        IsLoading = true;
        ErrorMessage = null;
        
        try
        {
            var username = await UserSession.GetEmpId();
            
            if (string.IsNullOrEmpty(username))
            {
                ErrorMessage = "Unable to retrieve username from session. Please log out and log back in.";
                return;
            }
            
            BookingsList = await BookingService.GetMyBookingsAsync(username);
        }
        catch (Exception ex) 
        { 
            ErrorMessage = $"Error loading bookings: {ex.Message}";
            Console.WriteLine($"Error in LoadBookings: {ex.ToString()}");
        }
        finally 
        { 
            IsLoading = false; 
        }
    }

    private string GetCleanRemark(string rawRemark)
    {
        if (string.IsNullOrEmpty(rawRemark)) return "-";
        string cleanRemark = rawRemark;
        if (cleanRemark.Contains("|")) { var parts = cleanRemark.Split('|'); cleanRemark = parts.LastOrDefault()?.Trim() ?? ""; }
        else if (cleanRemark.Trim().StartsWith("Phone:")) { return "-"; }
        int bracketIndex = cleanRemark.IndexOf("[");
        if (bracketIndex > 0) { cleanRemark = cleanRemark.Substring(0, bracketIndex).Trim(); }
        return string.IsNullOrWhiteSpace(cleanRemark) ? "-" : cleanRemark;
    }

    private void OpenDetails(BookingListVM item) { SelectedBooking = item; ShowModal = true; }
    private void CloseModal() { ShowModal = false; SelectedBooking = null; }
    private void GoToCreate() { NavManager.NavigateTo("/book-hall"); }

    private async Task CancelBooking(BookingListVM item)
    {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this entire booking? All active sessions will be cancelled.");
        if (confirm)
        {
            bool success = await BookingService.CancelBookingAsync(item.BookingId);
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Booking cancelled successfully!");
                await LoadBookings();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to cancel booking. Please try again.");
            }
        }
    }

    private async Task CancelSpecificSession(int sessionRecordId)
    {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Cancel session?");
        if (confirm)
        {
            await BookingService.CancelSessionAsync(sessionRecordId);
            await LoadBookings();
            if (SelectedBooking != null)
            {
                var updated = BookingsList.FirstOrDefault(b => b.BookingId == SelectedBooking.BookingId);
                if (updated == null || updated.ActiveSessionsCount == 0) CloseModal(); else SelectedBooking = updated;
            }
        }
    }
}